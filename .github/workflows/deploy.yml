name: Build and Deploy Spring Boot to EC2

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Run Test and Build (Maven)
        run: mvn -B package

      - name: Create app.jar
        shell: bash
        run: |
          JAR_PATH="$(ls -1 target/*.jar | grep -vE '(original|sources|javadoc)\.jar$' | head -n 1)"
          if [ -z "$JAR_PATH" ]; then
            echo "No runnable jar found in target/. Contents:"
            ls -lah target || true
            exit 1
          fi

          cp "$JAR_PATH" app.jar
          ls -lah app.jar

      - name: Configure SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SERVER_IP }}" >> ~/.ssh/known_hosts

      - name: Upload app.jar to EC2
        shell: bash
        run: |
          scp -i ~/.ssh/id_rsa \
            app.jar \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/home/ubuntu/app/app.jar"

      - name: Restart service on EC2
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}" \
            "sudo systemctl restart springboot-app.service && sudo systemctl --no-pager --full status springboot-app.service | sed -n '1,30p'"
